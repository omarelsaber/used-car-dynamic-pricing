name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ============================================================================
  # Job 1: Code Quality Checks
  # ============================================================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install Linting Tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort
      
      - name: Run Flake8 (Non-blocking)
        continue-on-error: true
        run: |
          flake8 src/ --count --max-line-length=120 --statistics --exit-zero
      
      - name: Check Black Formatting
        continue-on-error: true
        run: |
          black --check --line-length 120 src/
      
      - name: Check Isort
        continue-on-error: true
        run: |
          isort --check-only --profile black src/

  # ============================================================================
  # Job 2: Unit Tests
  # ============================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run Tests
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing
      
      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          fail_ci_if_error: false

  # ============================================================================
  # Job 3: Security Scan
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      
      - name: Install Security Tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit
      
      - name: Run Safety Check
        continue-on-error: true
        run: |
          safety check --json || true
      
      - name: Run Bandit
        continue-on-error: true
        run: |
          bandit -r src/ -f json || true

  # ============================================================================
  # Job 4: Docker Build & Config Validation
  # ============================================================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Create Dummy .env File
        run: |
          echo "API_HOST=0.0.0.0" >> .env
          echo "API_PORT=8001" >> .env
          echo "API_URL=http://localhost:8001" >> .env
          echo "MODEL_VERSION=xgboost_v5.0_cardekho" >> .env
          echo "MODEL_PATH=models/model.pkl" >> .env
          echo "PREPROCESSOR_PATH=models/preprocessor.pkl" >> .env
          echo "LOG_LEVEL=info" >> .env
      
      - name: Verify Docker Compose Config
        run: docker-compose config > /dev/null
      
      - name: Build Docker Images
        run: docker-compose build
      
      - name: Test Docker Services
        run: |
          docker-compose up -d
          sleep 10
          docker-compose ps
      
      - name: Cleanup
        if: always()
        run: docker-compose down -v

  # ============================================================================
  # Job 5: Summary
  # ============================================================================
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, security, docker]
    if: always()
    
    steps:
      - name: Check Results
        run: |
          echo "=== CI Pipeline Summary ==="
          echo "Code Quality: ${{ needs.code-quality.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Docker: ${{ needs.docker.result }}"
          
          if [ "${{ needs.unit-tests.result }}" == "failure" ]; then
            echo " Unit tests failed - blocking merge"
            exit 1
          fi
          
          if [ "${{ needs.docker.result }}" == "failure" ]; then
            echo " Docker build failed - blocking merge"
            exit 1
          fi
          
          echo " CI Pipeline passed"
